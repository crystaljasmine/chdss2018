---
title: '<div class="jumbotron"><h1 class="title toc-ignore display-3">Mixed models in R</h1></div>'
author: "Danielle Navarro"
date: "5 December 2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<!--

  html_document:
    includes:
      in_header: header.html
    theme: flatly
    highlight: textmate
    css: mystyle.css

-->

```{r}
library(here)
library(tidyverse)
library(lme4)
frames <- read_csv(here("analysis","data","frames_ex2.csv"))
```



## Example 1: A simple mixed model

To get started with mixed models, we will look at a version of the `frames` data that is a little more complex than the `tinyframes` data from the last section, but not quite the full thing yet. Specifically, what we'll do is take the (within-subject) average responses across every `test_item`, but we *won't* average across the different values of `n_obs`. That gives us a `modestframes` data set:

```{r}
modestframes <- frames %>% 
  group_by(id, age, condition, n_obs) %>%
  summarise(response = mean(response)) %>%
  ungroup()

glimpse(modestframes)
```


Sequence of models:

```{r modestframeslmer, cache = TRUE}
modest1 <- lmer(formula = response ~ 1 + (1|id), data = modestframes)
modest2 <- lmer(formula = response ~ condition + (1|id), data = modestframes)
modest3 <- lmer(formula = response ~ condition + (1 + n_obs|id), data = modestframes)
modest4 <- lmer(formula = response ~ condition + age + (1 + n_obs|id), data = modestframes)
```

Okay let's compare these models in sequence:

```{r}
anova(modest1, modest2, modest3, modest4)
```

So `modest3` looks good:

```{r}
summary(modest3)
```

Add a column to the data with the fitted values:

```{r}
modestframes$modelfit <- predict(modest3)
```

Plot fitted values against data as a check:

```{r}
modestframes %>% 
  ggplot(aes(x = modelfit, y = response)) + 
  geom_point() + 
  facet_grid(condition ~ n_obs) + 
  geom_abline(intercept = 0, slope = 1)
```

Let's explore this a bit more substantively:

```{r}
whichids <- sample(unique(modestframes$id), 50) 
modestframes %>%
  filter(id %in% whichids) %>%
  ggplot(aes(x = n_obs, y = response, colour = factor(id))) +
  geom_point(show.legend = FALSE) + 
  geom_line(show.legend = FALSE, alpha = .3) + 
  facet_wrap(~ condition)
```
  

## Example 2: Mixed models with more complex designs


```{r}
whichids <- sample(unique(frames$id), 20) 
frames %>%
  filter(id %in% whichids) %>%
  ggplot(aes(x = test_item, y = response, shape = condition, colour = factor(n_obs))) +
  geom_point() + 
  geom_line(alpha = .3) + 
  facet_wrap(~ id)
```

```{r linframes, cache = TRUE}
linframes1 <- lmer(formula = response ~ condition + (1 + n_obs|id), data = frames)
linframes2 <- lmer(formula = response ~ condition + (1 + test_item + n_obs|id), data = frames)
linframes3 <- lmer(formula = response ~ condition + test_item + (1 + test_item + n_obs|id), data = frames)
```

```{r}
anova(linframes1, linframes2, linframes3)
```

```{r}
summary(linframes3)
```

```{r}
linframes <- frames
linframes$modelfit <- predict(linframes3)
linframes$residuals <- residuals(linframes3)
```

```{r} 
linframes %>%
  filter(id %in% whichids) %>%
  ggplot(aes(x = test_item, y = response, shape = condition, colour = factor(n_obs))) +
  geom_point() + 
  geom_line(aes(y = modelfit), alpha = .3) + 
  facet_wrap(~ id)
```

- crude notes: REML fits the fixed effects first, then estimates the random effects; whereas ML does them jointly. General advice is that you have to test fixed effects using the ML fits; to test random effects you can do it either way, but REML is generally preferred (for reasons).

## Generalised linear mixed models

```{r}
glmerframes <- frames %>% mutate(generalisation = (response+.1)/9.2)
```

```{r glmer, cache=TRUE}
logitmod <- glmer(
  formula = generalisation ~ condition + test_item + n_obs + (1 + test_item + n_obs|id), 
  family = gaussian(link = "logit"), 
  data = glmerframes)
```

```{r}
summary(logitmod)

glmerframes$modelfit <- predict(logitmod, type="response")
glmerframes$residuals <- residuals(logitmod, type="response")

glmerframes %>%
  filter(id %in% whichids) %>%
  ggplot(aes(x = test_item, y = generalisation, shape = condition, colour = factor(n_obs))) +
  geom_point() + 
  geom_line(aes(y = modelfit), alpha = .3) + 
  facet_wrap(~ id)
```

## Where next?

Bayesian approaches

- The `brms` package 
- The `BayesFactor` package
- More generally, JAGS and Stan

Other kinds of models

- Decision trees and random forests
- Structural equations models 
