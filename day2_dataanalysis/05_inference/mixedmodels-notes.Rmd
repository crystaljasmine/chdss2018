---
title: '<div class="jumbotron"><h1 class="title toc-ignore display-3">Mixed models in R</h1></div>'
author: "Danielle Navarro"
date: "5 December 2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<!--

  html_document:
    includes:
      in_header: header.html
    theme: flatly
    highlight: textmate
    css: mystyle.css

-->

```{r}
library(here)
library(tidyverse)
frames <- read_csv(here("analysis","data","frames_ex2.csv"))
```

## Mixed models 1

```{r}
library(lme4)
```

```{r}
frames_ss <- frames %>% 
  group_by(id, age, condition, n_obs) %>%
  summarise(response = mean(response)) %>%
  ungroup()
frames_ss
```

<!--
Let's do something boring. Same models:

```{r}
mod1 <- lmer(formula = response ~ 1 + (1|id), data = frames_ss)
mod2 <- lmer(formula = response ~ condition + (1|id), data = frames_ss)
mod3 <- lmer(formula = response ~ condition + age + (1|id), data = frames_ss)
```

```{r}
anova(mod1, mod2, mod3)
```
-->


Sequence of models:

```{r}
mod1 <- lmer(formula = response ~ 1 + (1|id), data = frames_ss)
mod2 <- lmer(formula = response ~ condition + (1|id), data = frames_ss)
mod3 <- lmer(formula = response ~ condition + (1 + n_obs|id), data = frames_ss)
mod4 <- lmer(formula = response ~ condition + age + (1 + n_obs|id), data = frames_ss)
```

Okay let's compare these models in sequence:

```{r}
anova(mod1, mod2, mod3, mod4)
```

So `mod3` looks good:

```{r}
summary(mod3)
```

Add a column to the data with the fitted values:

```{r}
frames_ss$modelfit <- predict(mod3)
```

Plot fitted values against data as a check:

```{r}
frames_ss %>% 
  ggplot(aes(x = modelfit, y = response)) + 
  geom_point() + 
  facet_grid(condition ~ n_obs) + 
  geom_abline(intercept = 0, slope = 1)
```

Let's explore this a bit more substantively:


```{r}
whichids <- sample(unique(frames_ss$id), 50) 
frames_ss %>%
  filter(id %in% whichids) %>%
  ggplot(aes(x = n_obs, y = response, colour = factor(id))) +
  geom_point(show.legend = FALSE) + 
  geom_line(show.legend = FALSE, alpha = .3) + 
  facet_wrap(~ condition)
```
  

## Mixed models 2


```{r}
whichids <- sample(unique(frames$id), 20) 
frames %>%
  filter(id %in% whichids) %>%
  ggplot(aes(x = test_item, y = response, shape = condition, colour = factor(n_obs))) +
  geom_point() + 
  geom_line(alpha = .3) + 
  facet_wrap(~ id)
```

```{r}
mod1 <- lmer(formula = response ~ condition + (1 + n_obs|id), data = frames)
mod2 <- lmer(formula = response ~ condition + (1 + test_item + n_obs|id), data = frames)
mod3 <- lmer(formula = response ~ condition + test_item + (1 + test_item + n_obs|id), data = frames)
```

```{r}
anova(mod1, mod2, mod3)
```

```{r}
summary(mod3)
```

```{r}
frames$modelfit <- predict(mod3)
frames$residuals <- residuals(mod3)
```

```{r} 
frames %>%
  filter(id %in% whichids) %>%
  ggplot(aes(x = test_item, y = response, shape = condition, colour = factor(n_obs))) +
  geom_point() + 
  geom_line(aes(y = modelfit), alpha = .3) + 
  facet_wrap(~ id)
```

- crude notes: REML fits the fixed effects first, then estimates the random effects; whereas ML does them jointly. General advice is that you have to test fixed effects using the ML fits; to test random effects you can do it either way, but REML is generally preferred (for reasons).

## Generalised linear mixed models

```{r glmer, cache=TRUE}
frames <- frames %>% mutate(generalisation = (response+.1)/9.2)
mod <- glmer(
  formula = generalisation ~ condition + test_item + n_obs + (1 + test_item + n_obs|id), 
  family = gaussian(link = "logit"), 
  data = frames)
```

```{r}
summary(mod)

frames$modelfit <- predict(mod, type="response")
frames$residuals <- residuals(mod, type="response")

frames %>%
  filter(id %in% whichids) %>%
  ggplot(aes(x = test_item, y = generalisation, shape = condition, colour = factor(n_obs))) +
  geom_point() + 
  geom_line(aes(y = modelfit), alpha = .3) + 
  facet_wrap(~ id)
```

## Where next?

Bayesian approaches

- The `brms` package 
- The `BayesFactor` package
- More generally, JAGS and Stan

Other kinds of models

- Decision trees and random forests
- Structural equations models 
